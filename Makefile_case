OUTPUT_DIR  ?= /mnt/treasure/zhangyang/asc-rna/output
INPUT_DIR   ?= /mnt/treasure/zhangyang/asc-rna/input

CUTSEQ      ?= ./cutseq/bin/cutseq
HISAT       ?= ./hisat-3n/hisat-3n
HISAT_BUILD ?= ./hisat-3n/hisat-3n-build
HISAT_TABLE ?= ./hisat-3n/hisat-3n-table
UMICOLLAPSE ?= java -server -Xms8G -Xmx40G -Xss100M -Djava.io.tmpdir=/mnt/treasure/zhangyang/asc-rna/tmp -jar ./umicollapse.jar
SAMTOOLS    ?= ./samtools/samtools

${OUTPUT_DIR}/${CASE_ID}.fastq: ${INPUT_DIR}/${CASE_ID}/${CASE_ID}.sra # 这一步也不计时
	./sra-tools/bin/fasterq-dump $^ --concatenate-reads -o $@ 

${OUTPUT_DIR}/${CASE_ID}.fastq_cut: ${OUTPUT_DIR}/${CASE_ID}.fastq
	${CUTSEQ} $^ -t 20 -A INLINE -m 20 --trim-polyA --ensure-inline-barcode -o ${OUTPUT_DIR}/${CASE_ID}.fastq_cut -s ${OUTPUT_DIR}/${CASE_ID}.fastq_tooshort -u ${OUTPUT_DIR}/${CASE_ID}.fastq_untrimmed

${OUTPUT_DIR}/${CASE_ID}.ncrna.unmapped.bam: ${OUTPUT_DIR}/${CASE_ID}.fastq_cut
	${HISAT} --index ${OUTPUT_DIR}/Homo_sapiens.GRCh38.ncrna.fa --summary-file ${OUTPUT_DIR}/${CASE_ID}_map2ncrna.output.summary --new-summary -q -U ${OUTPUT_DIR}/${CASE_ID}.fastq_cut -p 16 --base-change C,T --mp 8,2 --no-spliced-alignment --directional-mapping | ${SAMTOOLS} view -@ 16 -e '!flag.unmap' -O BAM -U ${OUTPUT_DIR}/${CASE_ID}.ncrna.unmapped.bam -o ${OUTPUT_DIR}/${CASE_ID}.ncrna.mapped.bam
	# 中间会有一个 Warning: Unsupported file format

${OUTPUT_DIR}/${CASE_ID}.mRNA.fastq: ${OUTPUT_DIR}/${CASE_ID}.ncrna.unmapped.bam
	${SAMTOOLS} fastq -@ 16 -O $^ > $@

${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.bam: ${OUTPUT_DIR}/${CASE_ID}.mRNA.fastq
	${HISAT} --index ${OUTPUT_DIR}/Homo_sapiens.GRCh38.dna.primary_assembly.fa -p 16 --summary-file ${OUTPUT_DIR}/${CASE_ID}_map2genome.output.summary --new-summary -q -U ${OUTPUT_DIR}/${CASE_ID}.mRNA.fastq --directional-mapping --base-change C,T --pen-noncansplice 20 --mp 4,1 | ${SAMTOOLS} view -@ 16 -e '!flag.unmap' -O BAM -U ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.unmapped.bam -o ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.bam
	# 可以适当改大 hisat 的并行数

${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.bam: ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.bam
	${SAMTOOLS} sort -@ 16 --write-index -O BAM -o $@ $^

# TODO: 输出文件没有被直接引用，确认是否真的需要
${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.bam.tsv: ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.bam
	${SAMTOOLS} view -@ 20 -F 3980 -c $^ > $@

${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.bam: ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.bam ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.bam.tsv # 不确定的依赖
	${UMICOLLAPSE} bam -t 2 -T 16 --data naive --merge avgqual --two-pass -i $< -o $@ > ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.log

# TODO: 输出文件没有被直接引用，确认是否真的需要
${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.bam.bai: ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.bam
	${SAMTOOLS} index -@ 8 $^ $@

${OUTPUT_DIR}/${CASE_ID}_unfiltered_uniq.tsv.gz: ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.bam ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.bam.bai
	${SAMTOOLS} view -e "rlen<100000" -h ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.bam | ${HISAT_TABLE} -p 16 -u --alignments - --ref ${OUTPUT_DIR}/Homo_sapiens.GRCh38.dna.primary_assembly.fa --output-name /dev/stdout --base-change C,T | cut -f 1,2,3,5,7 | gzip -c > ${OUTPUT_DIR}/${CASE_ID}_unfiltered_uniq.tsv.gz

${OUTPUT_DIR}/${CASE_ID}_unfiltered_multi.tsv.gz: ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.bam ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.bam.bai
	${SAMTOOLS} view -e "rlen<100000" -h ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.bam | ${HISAT_TABLE} -p 16 -m --alignments - --ref ${OUTPUT_DIR}/Homo_sapiens.GRCh38.dna.primary_assembly.fa --output-name /dev/stdout --base-change C,T | cut -f 1,2,3,5,7 | gzip -c > ${OUTPUT_DIR}/${CASE_ID}_unfiltered_multi.tsv.gz
	# hisat-table 部分很慢，每个 thread cpu 占用率不高，代码不长，可能要重写

${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.filtered.bam: ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.bam ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.bam.bai
	${SAMTOOLS} view -@ 8 -e "[XM] * 20 <= (qlen-sclen) && [Zf] <= 3 && 3 * [Zf] <= [Zf] + [Yf]" $< -O BAM -o $@

${OUTPUT_DIR}/${CASE_ID}_filtered_uniq.tsv.gz: ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.filtered.bam
	${SAMTOOLS} view -e "rlen<100000" -h ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.filtered.bam | ${HISAT_TABLE} -p 16 -u --alignments - --ref ${OUTPUT_DIR}/Homo_sapiens.GRCh38.dna.primary_assembly.fa --output-name /dev/stdout --base-change C,T | cut -f 1,2,3,5,7 | gzip -c > ${OUTPUT_DIR}/${CASE_ID}_filtered_uniq.tsv.gz

${OUTPUT_DIR}/${CASE_ID}_filtered_multi.tsv.gz: ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.filtered.bam
	${SAMTOOLS} view -e "rlen<100000" -h ${OUTPUT_DIR}/${CASE_ID}.mRNA.genome.mapped.sorted.dedup.filtered.bam | ${HISAT_TABLE} -p 16 -m --alignments - --ref ${OUTPUT_DIR}/Homo_sapiens.GRCh38.dna.primary_assembly.fa --output-name /dev/stdout --base-change C,T | cut -f 1,2,3,5,7 | gzip -c > ${OUTPUT_DIR}/${CASE_ID}_filtered_multi.tsv.gz

${OUTPUT_DIR}/${CASE_ID}_genome.arrow: ${OUTPUT_DIR}/${CASE_ID}_unfiltered_uniq.tsv.gz ${OUTPUT_DIR}/${CASE_ID}_unfiltered_multi.tsv.gz ${OUTPUT_DIR}/${CASE_ID}_filtered_uniq.tsv.gz ${OUTPUT_DIR}/${CASE_ID}_filtered_multi.tsv.gz
	./m5C-UBSseq/bin/python m5C-UBSseq/bin/join_pileup.py -i $^ -o $@
